<html lang="ru">
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://fluidsync2.herokuapp.com/socket.io/socket.io.js"></script>
    <script src="fluidsync_redis_ps_proxy.js"></script>

    <script>
                
        function print(s)
        {
            $('body').append('<p>' + s + '</p>');       
        }
        /*
        // pure sockets style
        
        var feedbackChannel;
        $(() => {
            let socket = io('https://fluidsync2.herokuapp.com');
        
            socket.on('connect', () => {    
                feedbackChannel = 'redis-ret-' + socket.id;
                socket.on(feedbackChannel, (message) => {
                    print(message.from + ':');                
                    print('id: ' + message.payload.id);
                    print('error: ' + message.payload.error);
                    print('reply: ' + message.payload.reply);
                }); 
                socket.emit('subscribe', feedbackChannel);
                print('FluidSync2 Redis connection: ' + socket.id);
            });
            
            let sendButton = $('#sendButton');
            sendButton.click(() => 
            {
                socket.emit('publish', {channel: 'redis-command-unique_instance_name', from: socket.id, payload: 
                {feedbackChannel: feedbackChannel, id: '11', command: 'set', args: ['foo', 'bar' + Math.random()]}}); 
            });            
        });
        */
        //*
        // proxy helper style
        $(() => {
            function onConnect(redis)
            {
                print('FluidSync2 Redis connection: ' + redis.redisSocket.id);    
                redis.onEvent = (message) => {

                    console.log(message);

                    print('event: ' + message.event);    
                };
            }

            let redis = new redisProxy('https://fluidsync2.herokuapp.com', 'unique_instance_name', onConnect);

            let sendButton = $('#sendButton');
            let subscribeButton = $('#subscribeButton');
            let unsubscribeButton = $('#unsubscribeButton');
            let subscribePatternButton = $('#subscribePatternButton');
            let unsubscribePatternButton = $('#unsubscribePatternButton');

            sendButton.click(() => 
            {
                redis.sendCommand('set', ['foo', 'bar' + Math.random()], (err, reply) => {
                    print('error: ' + err);
                    print('reply: ' + reply);                
                });
            });      
            
            subscribeButton.click(() => {
                redis.sendCommand('subscribe', ['poo'], (err, reply) => {
                    print('error: ' + err);
                    print('reply: ' + reply);                
                });                    
            });
                        
            unsubscribeButton.click(() => {
                redis.sendCommand('unsubscribe', ['poo'], (err, reply) => {
                    print('error: ' + err);
                    print('reply: ' + reply);                
                });                                    
            });

            subscribePatternButton.click(() => {
                redis.sendCommand('psubscribe', ['q*'], (err, reply) => {
                    print('error: ' + err);
                    print('reply: ' + reply);                
                });                    
            });
                        
            unsubscribePatternButton.click(() => {
                redis.sendCommand('punsubscribe', ['q*'], (err, reply) => {
                    print('error: ' + err);
                    print('reply: ' + reply);                
                });                                    
            });            
        });
        //*/
    </script>
<body> 
    <button id="sendButton">
        Set foo bar
    </button>   

    <button id="subscribeButton">
        Subscribe poo
    </button>
    
    <button id="unsubscribeButton">
        Unsubscribe poo
    </button>

    <button id="subscribePatternButton">
        Subscribe q*
    </button>
    
    <button id="unsubscribePatternButton">
        Unsubscribe q*
    </button>
    
</body>
</html>
